<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Delivery Form</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #121212;
      color: #e0e0e0;
      margin: 0; padding: 0;
    }
    .container {
      width: 90%; max-width: 700px;
      margin: 20px auto; padding: 20px;
      background: #1e1e1e; border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.5);
    }
    h2 { text-align: center; margin-bottom: 20px; color: #ffffff; }
    .branch { display: none; }
    .branch.active { display: block; }
    .product {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 12px; padding: 8px;
      background: #2a2a2a; border-radius: 8px;
    }
    .product span { font-weight: bold; color: #e0e0e0; }
    input[type="number"] {
      width: 80px; padding: 6px; border-radius: 6px;
      border: none; text-align: center; background: #121212; color: #fff;
    }
    button {
      padding: 12px 24px; margin: 10px 5px 0 5px;
      background: #333333; border: none; border-radius: 10px;
      color: #ffffff; font-weight: bold; cursor: pointer; transition: 0.2s;
    }
    button:hover { background: #555555; }
    .buttons { text-align: center; }
    h3 { text-align: center; margin-bottom: 15px; color: #ffffff; }
  </style>
</head>
<body>
  <div class="container">
    <h2>Delivery Form</h2>
    <div id="branches-container"></div>
    <div class="buttons">
      <button onclick="prevBranch()">Previous</button>
      <button onclick="nextBranch()">Next</button>
      <button onclick="submitData()">Submit</button>
    </div>
  </div>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script>
    const tg = window.Telegram.WebApp;
    tg.ready();

    const urlParams = new URLSearchParams(window.location.search);
    const gist_url = urlParams.get("gist_url");  // original bot-created Gist
    const GITHUB_TOKEN = urlParams.get("token"); // token passed from bot

    let branches = [];
    let deliveryData = [];
    let currentBranchIndex = 0;

    async function loadData() {
      if (!gist_url) return alert("⚠️ No data source provided.");
      try {
        const res = await fetch(gist_url);
        const data = await res.json();
        branches = data.branches || [];
        deliveryData = data.delivery || {};
        renderBranch(currentBranchIndex);
      } catch (err) {
        console.error(err);
        alert("⚠️ Failed to load delivery data.");
      }
    }

    const container = document.getElementById("branches-container");

    function renderBranch(index){
      container.innerHTML = "";
      const branch = branches[index];
      const div = document.createElement("div");
      div.className = "branch active";
      div.innerHTML = `<h3>${branch.branchname}</h3>`;
      branch.products.forEach(p => {
        const pDiv = document.createElement("div");
        pDiv.className = "product";
        pDiv.innerHTML = `<span>${p.productname} (left: ${p.totalleft || 0})</span>
                          <input type="number" min="0" data-productid="${p.productid}" data-productname="${p.productname}">`;
        div.appendChild(pDiv);
      });
      container.appendChild(div);
    }

    function prevBranch(){ if(currentBranchIndex > 0){ currentBranchIndex--; renderBranch(currentBranchIndex); } }
    function nextBranch(){ if(currentBranchIndex < branches.length -1){ currentBranchIndex++; renderBranch(currentBranchIndex); } }

    async function createGist(submittedBranches){
      const payload = { files: { "delivery_submission.json": { content: JSON.stringify({ branches: submittedBranches, delivery: deliveryData }, null, 2) } }, public: false };
      const res = await fetch("https://api.github.com/gists", {
        method: "POST",
        headers: { "Authorization": `token ${GITHUB_TOKEN}`, "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      if(!res.ok) throw new Error("Failed to create Gist");
      const gist = await res.json();
      return gist.files["delivery_submission.json"].raw_url;
    }

    async function deleteGist(originalUrl){
      try {
        const parts = originalUrl.split("/");
        const gistId = parts[parts.indexOf("gists")+1]; if(!gistId) return;
        await fetch(`https://api.github.com/gists/${gistId}`, { method:"DELETE", headers:{"Authorization":`token ${GITHUB_TOKEN}`} });
      } catch(err){ console.warn("Could not delete original gist:", err); }
    }

    async function submitData(){
      // Collect quantities
      container.querySelectorAll(".branch input").forEach(input => {
        branches.forEach(branch => {
          branch.products.forEach(p => { if(p.productid==input.dataset.productid) p.quantity = parseInt(input.value)||0; });
        });
      });

      const hasAny = branches.some(b => (b.products||[]).some(p => (p.quantity||0) > 0));
      if(!hasAny) return alert("⚠️ Please enter at least one non-zero quantity.");

      try {
        const newGistUrl = await createGist(branches);
        if(gist_url) await deleteGist(gist_url);
        tg.sendData(JSON.stringify({ gist_url: newGistUrl }));
        tg.close();
      } catch(err){ console.error(err); alert("⚠️ Failed to save data."); }
    }

    loadData();
  </script>
</body>
</html>
